name: Update AI Tools from Hugging Face

on:
  schedule:
    - cron: '0 0 * * 2'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch trending Hugging Face Spaces
        run: |
          curl -s "https://huggingface.co/api/spaces?sort=trending" > hf-spaces.json

          cat hf-spaces.json | jq -r '
          .[] |
          {
            name: (.id | split("/")[1]),
            url: ("https://huggingface.co/spaces/" + .id),
            githubUrl: (.repoUrl // ""),
            description: ((.cardData.description // "No description") | tostring | sub("\\n.*$"; "") | .[:200]),
            stars: .likes,
            tags: ["AI", "LLM Apps", "Open Source", "Hugging Face"] + (.cardData.tags[:3] // []),
            hasApi: (.cardData.sdk == "gradio" or .cardData.sdk == "streamlit"),
            useCases: ["LLM Apps", "Agents", "Open Source"]
          }' > new-tools.json

      - name: Merge with existing tools.json
        run: |
          python << 'EOF'
          import json

          try:
              with open('new-tools.json') as f:
                  new_tools = json.load(f)
          except Exception as e:
              print(f"Error loading new tools: {e}")
              new_tools = []

          try:
              with open('tools.json', 'r') as f:
                  existing_tools = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              existing_tools = []

          existing_names = {tool['name'].strip().lower() for tool in existing_tools if 'name' in tool}
          added = 0

          for tool in new_tools:
              name = tool['name'].strip().lower()
              if name and name not in existing_names:
                  existing_tools.append(tool)
                  existing_names.add(name)
                  added += 1

          with open('tools.json', 'w', encoding='utf-8') as f:
              json.dump(existing_tools, f, indent=2, ensure_ascii=False)

          print(f"âœ… Added {added} new tools from Hugging Face")
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tools.json
          git diff-index --quiet HEAD || git commit -m "ðŸ¤– Auto-update: Add tools from Hugging Face"
          git push "https://x-access-token:${{ secrets.REPO_PAT }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref }}