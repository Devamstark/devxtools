name: Update AI Tools from GitHub

on:
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC
  workflow_dispatch:     # Allows manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.REPO_PAT }}
          ref: ${{ github.ref }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Fetch trending AI repositories
        run: |
          curl -s "https://api.github.com/search/repositories?q=topic:ai+sort:stars&per_page=20" > github-tools.json

          cat github-tools.json | jq -r '
          .items[] |
          {
            name: .name,
            url: .html_url,
            githubUrl: .html_url,
            description: (.description // "No description")[:200],
            stars: .stargazers_count,
            tags: ["AI", "Open Source", "GitHub Trending"],
            hasApi: false,
            useCases: ["LLM Apps"]
          }' > new-tools.json

      - name: Merge with existing tools.json
        run: |
          python << 'EOF'
          import json

          try:
              with open('new-tools.json', 'r') as f:
                  new_tools = json.load(f)
          except Exception as e:
              print(f"Error loading new tools: {e}")
              new_tools = []

          try:
              with open('tools.json', 'r') as f:
                  existing_tools = json.load(f)
          except (FileNotFoundError, json.JSONDecodeError):
              existing_tools = []

          existing_names = {tool['name'].strip().lower() for tool in existing_tools if 'name' in tool}
          added = 0

          for tool in new_tools:
              name = tool['name'].strip().lower()
              if name and name not in existing_names:
                  existing_tools.append(tool)
                  existing_names.add(name)
                  added += 1

          with open('tools.json', 'w', encoding='utf-8') as f:
              json.dump(existing_tools, f, indent=2, ensure_ascii=False)

          print(f"âœ… Added {added} new tools from GitHub")
          EOF

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add tools.json
          git diff-index --quiet HEAD || git commit -m "ðŸ¤– Auto-update: Add trending AI tools from GitHub"
          git push "https://x-access-token:${{ secrets.REPO_PAT }}@github.com/${{ github.repository }}.git" HEAD:${{ github.ref }}